<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.silence.mapper.MessageMapper">

    <sql id="allFields">
        id, from_id, to_id, conversation_id, content, status, create_time
    </sql>

    <select id="listConversationsPageByUserId" resultType="MessageDO">
        SELECT <include refid="allFields"/>
        FROM message
        WHERE id IN (
            SELECT MAX(id)
              FROM message
             WHERE status != 2
               AND from_id != 1
               AND (#{userId} = from_id OR #{userId} = to_id)
             GROUP BY conversation_id
        )
        ORDER BY id DESC
        LIMIT #{offset}, #{pageSize};
    </select>

    <select id="countConversationsByUserId" resultType="int">
        SELECT COUNT(m.max_id)
        FROM (
                SELECT MAX(id) AS max_id
                  FROM message
                 WHERE status != 2
                   AND from_id != 1
                   AND (#{userId} = from_id OR #{userId} = to_id)
                 GROUP BY conversation_id
        ) AS m;
    </select>

    <select id="listLettersByConversationId" resultType="MessageDO">
        SELECT <include refid="allFields"/>
          FROM message
         WHERE status != 2
           AND from_id != 1
           AND conversation_id = #{conversationId}
         ORDER BY id DESC
         LIMIT #{offset}, #{pageSize};
    </select>

    <select id="countLettersByConversationId" resultType="int">
        SELECT COUNT(id)
          FROM message
         WHERE status != 2
           AND from_id != 1
           AND conversation_id = #{conversationId};
    </select>

    <select id="countUnreadLetters" resultType="int">
        SELECT COUNT(id)
          FROM message
         WHERE status = 0
           AND from_id != 1
           AND to_id = #{userId}
       <if test="conversationId != null">
           AND conversation_id = #{conversationId}
       </if>
    </select>

    <insert id="saveMessage">
        INSERT INTO message
        VALUES(null, #{fromId}, #{toId}, #{conversationId}, #{content}, #{status}, #{createTime});
    </insert>

    <update id="updateStatus">
        UPDATE message
           SET status = #{status}
         WHERE id IN
         <foreach collection="ids" item="id" open="(" separator="," close=")">
             #{id}
         </foreach>
    </update>

    <select id="getLatestNotice" resultType="MessageDO">
        SELECT <include refid="allFields"/>
        FROM message
        WHERE id IN (
        SELECT max(id)
            FROM message
            WHERE status != 2
            AND from_id = 1
            AND to_id = #{userId}
            AND conversation_id = #{topic}
        );
    </select>

    <select id="countNotice" resultType="java.lang.Integer">
        SELECT COUNT(id)
          FROM message
         WHERE status != 2
           AND from_id = 1
           AND to_id = #{userId}
           AND conversation_id = #{topic};
    </select>

    <select id="countUnreadNotice" resultType="java.lang.Integer">
        SELECT COUNT(id)
          FROM message
         WHERE status = 0
           AND from_id = 1
           AND to_id = #{userId}
           <if test="topic != null">
               AND conversation_id = #{topic}
           </if>;
    </select>

    <select id="listNotices" resultType="MessageDO">
        SELECT <include refid="allFields"/>
          FROM message
         WHERE status != 2
           AND from_id = 1
           AND to_id = #{userId}
           AND conversation_id = #{topic}
         ORDER BY create_time DESC
         LIMIT #{offset}, #{pageSize};
    </select>


</mapper>